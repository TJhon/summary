---
title: IPA
---


# Librerias

```{r}
if(!require(librarian)) install.packages("librarian")
librarian::shelf(here, tidyverse, janitor, sjlabelled,  haven, glue, kableExtra, xlsx)
```

# 1 Replacement Workflow/Basic Data Cleaning

```{r}
fs::dir_tree(here('input'))
```

## hh_round1.dta


### Variables a modificar

Parece que la variable hhid esta en un formato que dificultara la identificacion de casos especiales modificare a numerico como una nueva variable (hhid1)

```{r}
llt <- c("hhid","read", "write", "head_gender",  "head_education", "size")
```


```{r}
h1 <- 
  read_dta(here("input", "hh_round1.dta"))
```


### 1 

```{r h1}
h1 <- 
  h1 %>% 
  relocate(llt) %>% 
  mutate(
    read = as.numeric(read)
    , write = as.numeric(write)
    , hhid1 = str_sub(hhid, 2, -1) %>% as.numeric()
  ) %>% 
  relocate(hhid1)
h1
```


### 2 Head-house

```{r h2}
h1 %>% 
  select(head_gender) %>% 
  mutate(head_gender = haven::as_factor(head_gender)) %>% 
  count(head_gender) %>% 
  mutate(percent = ((n / sum(n) * 100) %>% round(2)) %>% paste("%") ) %>% 
  select(!n) %>% 
  kableExtra::kable()
```

23.4%


### 3 label 0 = female

Primero sin colocar etiquetas

```{r}
h1 <- 
  h1 %>% 
  mutate(
    head_gender = ifelse(head_gender == 2, 0, 1) 
    , hhid1 = str_sub(hhid, 2, -1) %>% as.numeric()
  ) %>% 
  relocate(hhid1)

```

### 4, 5 y 6

Manual label

```{r}
 get_labels(h1$head_education) %>% 
  as_vector() %>% 
   enframe() %>% 
   mutate(gen = glue::glue_col("'{value}' = {name - 1 }")) %>% 
   pull(gen)
```


```{r}
label1 <- c(
'none' = 0
, 'nursery/ pre-unit' = 1
, 'std 1' = 2
, 'std 2' = 3
, 'std 3' = 4
, 'std 4' = 5
, 'std 5' = 6
, 'std 6' = 7
, 'std 7' = 8
, 'std 8' = 9
, 'form 1' = 10
, 'form 2' = 11
, 'form 3' = 12
, 'form 4' = 13
, 'form 5' = 14
, 'form 6' = 15
, 'uni. 1' = 16
, ' uni. 2' = 17
, ' uni. 3' = 18
, 'uni. 4' = 19
, 'uni. 5' = 20
, 'vocational training' = 21
, 'adult education' = 22
, 'other' = 23
, 'not indicated' = 24
, 'rta' = 25
)
```



```{r, h6}
h1 <- 
  h1 %>%
  mutate(
    hhid1 = hhid1 %>% as.character()
    , head_education =  head_education %>% 
      as.numeric()
    , head_gender = case_when(hhid1 == 15064 ~ 0, T ~ head_gender) %>% 
      haven::labelled(c("Female" = 0, "Male" = 1))
    , head_education = case_when(hhid1 == 29038 ~ 1, T ~ head_education) %>% 
      haven::labelled(label1)
    , read = case_when(hhid1 == 53024 ~ 3, T ~ read)
  ) %>% 
  rename(
    "Household_ID" = hhid1 # parte 5
    , hh_size = size # 6
    ) # parte 5
h1
```




## 7 promedio

```{r}
h1 %>% 
  select(head_gender, hh_size) %>% 
  group_by(head_gender) %>% 
  summarise(mean = mean(hh_size) %>% round(2)) %>% 
  kableExtra::kable()
```



## 8 Save

Dejo la variable hhid como "character" pero con 

```{r}
h1 %>% 
  select(!hhid) %>% 
  write_dta(here("output", "hh_round1_clean.dta"))
```


# 2 Import and Export Excel

```{r}
excel <- 
  readxl::read_xlsx(here("input", "round2.xlsx"), sheet = 'round2', skip = 2) %>% 
  mutate(hhid = str_sub(hhid, 2, -1) %>% as.numeric()) 
```

No entiendo bien lo que se pide, pero supongo que es crear una base de datos con identificadores duplicados y otra hoja que cuente la cantidad


## Duplicados

```{r}
dup <- 
  excel %>% 
  count(hhid) %>% 
  filter(n > 1) 
```

## Hoja 1

```{r}
options(scipen = 999)
excel %>% 
  filter(hhid %in% pull(dup, hhid)) %>% 
  mutate(hhid = as.character(hhid)) %>% 
  #write.xlsx()
  write.xlsx(here('output', 'new_round2.xlsx'),  sheetName =  "Data 1", append = T)
```


## Hoja 2

```{r}
dup %>% 
  mutate(hhid = as.character(hhid)) %>% 
  write.xlsx(here('output', 'new_round2.xlsx'),  sheetName =  "Duplicados count", append = T)
```


## En caso que requiera otra que no contenga los duplicados

```{r}
excel %>% 
  filter(!(hhid %in% pull(dup, hhid))) %>% 
  mutate(hhid = as.character(hhid)) %>% 
  write.xlsx(here('output', 'new_round2.xlsx'),  sheetName =  "No duplicados", append = T)
```



# 3 Survey Design Reconciliation

```{r}
join <- map(c('hh_nr_round1.dta', 'hh_round1.dta'), ~here('input', .x) %>% read_dta)

join
```

El problema de la base de datos "hh_nr_round1.dta" es que no la variable "cropl" no sirve para hacer una estimaicon, y la base de datos "hh_nr_roun.dta" son demasiadas columnas.

Para unir las 2 bases de datos se debe tener un mismo formato, aqui propongo 2 posibles resultados, yo sugiero usar el formato largo ya que esta serviria para hacer contrastaciones de hipotesis entre las personas que cultivan determinado producto. Mientras que los valores perdidos en este caso deberian ser rellenados con 0.

## Formato ancho

```{r}
join[[1]] <- 
  join[[1]] %>% 
  rename(cropl = crop_l) %>% 
  separate_rows(cropl) %>% 
  mutate(
    cropl = paste0("cropl", cropl)
    , value = 1
    ) 
join[[1]] %>%
  pivot_wider(names_from = cropl, values_from = value) %>% 
  mutate(across(contains('cropl'), replace_na, 0)) %>% 
  full_join(join[[2]]) %>% 
  mutate(hhid = as.character(hhid), across(2:42, replace_na, 0)) %>% 
  write_dta(here('output', 'hh_round_join_wider.dta'))
```


## Formato largo




```{r}
longer <- 
join[[2]] %>% 
  pivot_longer(contains('cropl'), names_to = "cropl") %>% 
  relocate(cropl, value) %>% 
  full_join(join[[1]]) %>% 
  mutate(hhid = as.character(hhid), across(2:29, replace_na, 0)) %>% 
  mutate(cropl = parse_number(cropl) %>% as_factor() %>%  haven::labelled(c(
    	"Rice" = 1
,	"Cassava" = 2
,	"Millet" = 3
,	"Groundnut" = 4
,	"Sweet Potato" = 5
,	"Wheat" = 6
,	"Sorghum" = 7
  ))) %>% 
  filter(value != 0) %>% 
  select(!value) 

longer
  longer %>% 
  write_dta(here('output', 'hh_round_join_longer.dta'))

  
```


```{r}
fs::dir_tree()
```

